# Torrent4.0 システムアーキテクチャ概念図

## 概要
Torrent4.0の開発チームが作成したシステムアーキテクチャの概念図です。マルチテナント対応のエンタープライズアプリケーション向けのマイクロサービスアーキテクチャを詳細に示しています。

## アーキテクチャの主要構成要素

### 1. テンプレート層（上部）
- **顧客別テンプレート**: 見積、受注、出荷サービス
- **標準テンプレート**:
  - 製造業・金属加工向けテンプレート
  - 製造業・食品加工向けテンプレート
- **リポジトリ分離**: デプロイとリポジトリの関係性

### 2. メインシステム（テナントごとに分離）

#### フロントエンド（マイクロ）
- 見積、受注、出荷の各フロントエンドコンポーネント
- ユーザーとの直接的なインタラクション

#### BFF（Backend for Frontend）
- 見積BFF、受注BFF、出荷BFF
- フロントエンドとバックエンドサービス間の仲介役

#### バックエンド（マイクロ）
- **見積サービス**: Kafka Listener付き
- **受注サービス**: Kafka Listener付き
- **出荷サービス**: Kafka Listener付き
- **ワークフローサービス（Flowable）**: Kafka Listener付き

#### データベース
- **見積DB**: 業務テーブル + Outboxテーブル
- **受注DB**: 業務テーブル + Outboxテーブル
- **出荷DB**: 業務テーブル + Outboxテーブル
- **ワークフローDB**: ワークフロー専用DB

#### メッセージング（イベント駆動）
- **トランザクションログ監視 & 変更イベント検知**
- **リレーサービス（Debezium）**: データベース変更イベントのキャプチャ
- **ブローカー（Apache Kafka）**: 中央メッセージブローカー
- **Outboxパターン**: 信頼性の高いイベント配信

### 3. テナント共通サービス

#### フロントエンド
- **統合基盤**: ポータル機能
- **ログイン**: 認証機能

#### BFF
- **統合基盤BFF**: 共通機能のBFF

#### バックエンド
- **共通サービス**: テナント共通のビジネスロジック
- **統合基盤サービス**: 統合機能のサービス
- **Idプロバイダ（認証サービス）**: 認証・認可

#### データベース
- **共通DB**: 共通テーブル
- **統合基盤DB**: 業務テーブル
- **DWH（Redshift）**: データウェアハウス

### 4. スタブFaaS
- **スタブサービス（AWS Lambda）**: テスト・一時統合用

## 重要な設計パターン

### Outboxパターン
- 各データベースにOutboxテーブルを配置
- 同一トランザクションで業務データとイベントデータを保存
- Debeziumによる変更イベントの検知とKafkaへの配信
- メッセージ配信の信頼性を保証

### イベント駆動アーキテクチャ
- Kafkaを中心とした非同期メッセージング
- サービス間の疎結合を実現
- スケーラビリティと可用性の向上

### マルチテナント設計
- テナント固有の業務ロジックとデータの分離
- テナント共通サービスの共有
- リソース効率とセキュリティの両立

## 技術スタック

### メッセージング
- **Apache Kafka**: メッセージブローカー
- **Debezium**: 変更データキャプチャ（CDC）

### ワークフロー
- **Flowable**: ビジネスプロセス管理

### データベース
- **業務DB**: 各サービス専用のデータベース
- **Amazon Redshift**: データウェアハウス

### インフラ
- **AWS Lambda**: サーバーレス関数
- **Kubernetes**: コンテナオーケストレーション（検討中）

## 重要な検討事項

### 運用面の課題
- 各業務テンプレート間の操作的な導線
- 統合基盤からの別業務画面への遷移方法
- 各業務テンプレート内での他業務へのリンク

### 技術的検討事項
- Torrent4.0向けのサービス・フレームワーク選定
- Kubernetesでの運用可否
- スタブサービスのテナント共通化の可能性

## アーキテクチャの特徴

1. **スケーラビリティ**: マイクロサービスによる水平スケーリング
2. **信頼性**: Outboxパターンによる確実なイベント配信
3. **保守性**: サービス間の疎結合による独立した開発・デプロイ
4. **マルチテナント**: テナント分離と共通サービスの効率的な運用
5. **イベント駆動**: リアルタイムな業務プロセスの連携

## 今後の検討事項

- 具体的な技術スタックの選定
- デプロイメント戦略の詳細化
- セキュリティ要件の詳細設計
- パフォーマンス要件の検証
- 運用・監視体制の構築

---
*作成日: 2025-01-15*
*作成者: Torrent4.0開発チーム*

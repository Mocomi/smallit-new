# Torrent4.0 レイヤ＆コンポーネント全体像

## 概要
Torrent4.0のシステムアーキテクチャを5つのレイヤに分けて整理した「レイヤ＆コンポーネントに関する全体像」の概念図です。各レイヤの役割とコンポーネントの詳細な構成を示しています。

## レイヤ構成

### 1. [Presentation] プレゼンテーション層

#### 主要コンポーネント
- **Micro Frontends**
  - 見積、受注、出荷、在庫、計画、実績などの機能別マイクロフロントエンド
  - 各機能が独立したフロントエンドとして構成

- **共通デザインシステム/i18n/Ally**
  - 統一されたデザインシステム
  - 国際化（i18n）対応
  - アクセシビリティ（Ally）対応

- **BFF per Domain**
  - ドメインごとのBackend for Frontend
  - GraphQL/REST API提供
  - 認可、集約、キャッシュ機能
  - 流行りのBFFアーキテクチャを採用

### 2. [Domain Templates] ドメインテンプレート層

#### 主要コンポーネント
- **ms-quote-core**
  - 見積のコアマイクロサービス
  - バーティカルパック対応（金属加工、食品加工など）

- **ms-order/ms-ship/ms-inventory**
  - 受注、出荷、在庫管理のマイクロサービス

- **ms-plan/ms-prod/ms-forecast**
  - 計画、生産、予測のマイクロサービス

- **database-per-service + Outbox**
  - サービスごとのデータベース分離
  - Outboxパターンによる整合性のあるイベント発行

### 3. [Platform] プラットフォーム層

#### 主要コンポーネント

##### 認証・認可
- **Identity & Access**
  - SSO（シングルサインオン）
  - RBAC/ABAC（ロールベース/属性ベースアクセス制御）
  - テナント分離
  - ★具体的な仕組みについて要検討

##### テナント管理
- **Tenant Manager & Billing**
  - テナント管理機能
  - 課金機能

##### テンプレート・プラグイン管理
- **Template/Plugin Registry**
  - テンプレート管理
  - バーティカルパック管理
  - 互換性管理
  - ★具体的な管理の仕組み要検討

##### 設定管理
- **AppConfig**
  - テナント設定管理
  - フィーチャーフラグ管理
  - マイクロフロントエンド（MFE）解決
  - 実行時動的変更対応
  - ★重要コンポーネント

##### メッセージング
- **Event Bus**
  - Pub/Subモデル
  - スキーマバージョン管理

##### ワークフロー
- **Workflow Orchestrator**
  - BPMN/DMN対応
  - Step Functions/Temporal対応
  - マイクロサービス間の承認フロー管理
  - システムワークフロー管理

##### データ管理
- **Canonical Data Model (CDM)**
  - API・イベント規約定義
  - 異なるシステム間のデータ連携基盤

- **Data Services**
  - 監査ログ
  - 全文検索
  - 分析連携/DWH

##### 監視・観測
- **Observability**
  - ログ収集・分析
  - メトリクス収集
  - トレース機能
  - ★具体的な仕組みについて要検討

### 4. [Integration] インテグレーション層

#### 主要コンポーネント
- **外部SaaS/社内システム連携**
  - 会計システム
  - EDI
  - WMS（倉庫管理システム）
  - SFA（営業支援システム）

- **Inbound API/Webhook/CDC**
  - 外部システムからのデータ連携
  - Inbound API提供
  - Webhook対応
  - Change Data Capture（CDC）

### 5. [Edge] エッジ層

#### 主要コンポーネント
- **Edge Agent**
  - 双方向同期機能
  - オフライン動作対応
  - ローカルUI提供
  - 周辺機器連携

- **デバイス連携**
  - OPC-UA対応
  - Modbus対応
  - ラベルプリンター連携
  - スキャナ連携
  - 秤連携

## アーキテクチャの特徴

### 1. レイヤ分離設計
- 各レイヤの責務を明確に分離
- 上位レイヤは下位レイヤに依存
- 疎結合な設計

### 2. マイクロサービス・マイクロフロントエンド
- 機能別の独立したサービス構成
- スケーラビリティと保守性の向上
- チーム別の独立開発・デプロイ

### 3. イベント駆動アーキテクチャ
- Event Busによる非同期通信
- Outboxパターンによる信頼性確保
- スキーマバージョン管理

### 4. マルチテナント対応
- テナント分離と共通サービスの両立
- テナント別設定管理
- バーティカルパック対応

### 5. エッジ対応
- オフライン動作
- ローカルデバイス連携
- 双方向同期

## 重要な検討事項（★マーク）

### 1. Identity & Access
- 具体的な認証・認可の仕組み
- テナント分離の実装方法
- SSOの統合方法

### 2. Template/Plugin Registry
- テンプレート管理の具体的な仕組み
- バーティカルパックの配布・更新方法
- 互換性管理の仕組み

### 3. AppConfig
- 実行時設定変更の仕組み
- フィーチャーフラグの管理方法
- MFE解決の仕組み

### 4. Observability
- ログ・メトリクス・トレースの具体的な仕組み
- 監視・アラートの設定方法
- パフォーマンス分析の仕組み

## 技術スタック（推測）

### フロントエンド
- マイクロフロントエンド（Module Federation等）
- 共通デザインシステム（Storybook等）

### バックエンド
- マイクロサービス（Spring Boot、Node.js等）
- BFF（GraphQL、REST API）
- ワークフローエンジン（Temporal、Step Functions等）

### データベース
- サービスごとのDB分離
- Outboxパターン実装

### メッセージング
- Event Bus（Apache Kafka等）
- スキーマレジストリ

### インフラ
- コンテナ化（Docker、Kubernetes）
- エッジ対応（Edge Computing）

## 今後の検討事項

1. **具体的な実装技術の選定**
2. **各レイヤ間のインターフェース定義**
3. **セキュリティ要件の詳細化**
4. **パフォーマンス要件の検証**
5. **運用・監視体制の構築**

---
*作成日: 2025-01-15*
*作成者: Torrent4.0開発チーム*

